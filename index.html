<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bflix</title>

<style>
    :root{
        --bg:#0a0a0a;
        --card:#111;
        --txt:#fff;
        --btn:#18ff8f;
        --delete-btn:#ff4d4d;
    }
    body.light{
        --bg:#f6f6f6;
        --card:#ffffff;
        --txt:#111;
        --btn:#00c06f;
        --delete-btn:#c00000;
    }

    body{
        background:var(--bg);
        margin:0;
        font-family:Arial, sans-serif;
        color:var(--txt);
        transition:.3s;
    }

    nav{
        background:#000;
        padding:15px 22px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:22px;
        /* Flex-wrap para acomodar mÃ¡s botones */
        flex-wrap:wrap; 
    }
    nav span{
        font-weight:bold;
        color:#18ff8f;
    }
    nav button{
        background:none;border:none;
        font-size:20px;color:white;
        cursor:pointer;
        /* Espacio para que no se peguen si hay muchos */
        margin-left: 10px; 
    }
    nav button:first-of-type {
        margin-right: 15px;
    }

    #home{
        text-align:center;margin-top:100px;
    }
    #home h1{font-size:38px;margin-bottom:6px;}
    #home p{opacity:.8;margin-bottom:25px;}
    #home button{
        padding:10px 24px;border-radius:6px;
        border:none;background:var(--btn);
        font-size:18px;font-weight:bold;
        cursor:pointer;
        margin: 5px; /* Espacio entre los botones de home */
    }

    #peticionesPanel, #reportPanel, #m3uPanel{
        display:none;padding:25px;
        max-width:800px;margin:auto;
    }

    .adminMode{color:#18ff8f;font-weight:bold;margin-bottom:10px;}

    .card{
        background:var(--card);
        padding:18px;
        border-radius:12px;
        margin-bottom:22px;
    }
    
    /* Estilo para las tarjetas de pelÃ­culas en M3U */
    .movieCard {
        background: var(--card);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 5px solid var(--btn);
        position: relative;
    }
    
    .movieCard h4 {
        margin-top: 0;
        color: var(--btn);
    }


    input,select{
        width:100%;padding:10px;margin-top:8px;
        background:#0003;border:none;
        border-radius:8px;color:var(--txt);
        font-size:16px;
    }
    
    /* Contenedor para los botones */
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    button.main{
        background:var(--btn);border:none;
        padding:11px 20px;font-weight:bold;
        border-radius:8px;width:100%;margin-top:10px;
        cursor:pointer;color:black;
    }
    
    /* Estilos para el botÃ³n de quitar pelÃ­cula */
    .remove-movie {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: var(--delete-btn);
        font-weight: bold;
        cursor: pointer;
    }

    .petItem{
        background:var(--card);
        padding:12px;border-radius:8px;
        display:flex;justify-content:space-between;
        margin-bottom:10px;
    }
    .acciones button{
        background:none;border:none;
        margin-left:6px;cursor:pointer;
    }
    .acciones .marcar{
        color:var(--btn);
    }
    .acciones .eliminar{
        color:var(--delete-btn);
    }
    .realizada{color:#00ff6a;font-weight:bold;}

    #popup{
        display:none;position:fixed;inset:0;
        background:#000000aa;backdrop-filter:blur(3px);
        justify-content:center;align-items:center;
    }
    #popup div{
        background:white;color:black;
        padding:25px;border-radius:12px;
        font-size:20px;text-align:center;
        animation:show .3s;
    }
    @keyframes show{from{scale:.6;opacity:0;}to{scale:1;opacity:1;}}
    
    /* Estilo para el popup de M3U */
    #m3uPopupContent {
        background: var(--card);
        color: var(--txt);
        width: 90%;
        max-width: 600px;
        padding: 25px;
        border-radius: 12px;
        animation: show .3s;
        text-align: left;
    }
    #m3uContent {
        width: 100%;
        height: 150px;
        background: #000;
        color: #fff;
        border: 1px solid var(--btn);
        padding: 10px;
        font-family: monospace;
        margin-top: 10px;
        resize: vertical;
        font-size: 12px;
    }
    #m3uPopupContent h3 {
        margin-top: 0;
    }

    /* Estilos para el input de tipo file oculto y el nuevo contenedor de URL */
    .file-input-container {
        display: none; 
        margin-bottom: 15px;
    }
    #m3uUrlInput {
        width: calc(100% - 22px);
        padding: 10px;
        margin-top: 10px;
        margin-bottom: 5px;
        background: var(--card);
        border: 1px solid #333;
        border-radius: 8px;
        color: var(--txt);
    }
</style>
</head>
<body>

<nav>
    <span>Bflix</span>
    <button onclick="volverAHome()" id="backButton" style="display:none;">ğŸ  Volver al MenÃº Principal</button>
    <button onclick="abrirPeticiones()">ğŸ“© Peticiones</button>
    <button onclick="abrirReportes()">ğŸš¨ Reportar CaÃ­do</button>
    <button onclick="abrirM3u()">ğŸ“½ï¸ M3u (Crear/Editar)</button>
</nav>

<section id="home">
    <h1>Bienvenido a Bflix</h1>
    <p>Centro multimedia, herramientas y peticiones.</p>
    <button onclick="abrirPeticiones()">Ir a Peticiones ğŸ“©</button>
    <button onclick="abrirReportes()">Reportar CaÃ­do ğŸš¨</button>
    <button onclick="abrirM3u(false)">Generar M3U ğŸ“½ï¸</button>
    <button onclick="abrirM3u(true)">Editar M3U ğŸ“</button>
</section>

<section id="m3uPanel">
    <h2 id="m3uPanelTitle">ğŸ“½ï¸ Generador de Archivos M3U</h2>
    
    <div class="card">
        <h3 id="m3uListTitle">Lista de PelÃ­culas</h3>
        
        <div id="m3uInputOptions" class="file-input-container">
            <h4 style="margin-bottom: 5px;">Cargar desde URL o Archivo</h4>
            
            <input type="url" id="m3uUrlInput" placeholder="Pega aquÃ­ el enlace directo (.m3u o .txt)">
            <button class="main" style="background:#00c0ff; margin-top:5px;" onclick="cargarUrlM3U()">Cargar desde URL ğŸŒ</button>
            
            <p style="text-align:center; margin: 10px 0;">--- O ---</p>

            <input type="file" id="m3uFileInput" accept=".m3u,.txt" onchange="cargarArchivoM3U(event)" style="display: none;">
            <button class="main" style="background:#ff9900; margin-top:5px;" onclick="document.getElementById('m3uFileInput').click()">Cargar M3U/TXT desde Archivo ğŸ“‚</button>
        </div>

        <div id="m3uMoviesContainer">
            </div>

        <div class="button-group">
            <button class="main" style="background:#444;" onclick="agregarPelicula()">AÃ±adir otra PelÃ­cula</button>
            <button class="main" onclick="generarM3u()">Generar M3U</button>
        </div>
        
    </div>
</section>
<section id="peticionesPanel">
    <div id="loginBox" class="card">
        <h2>Acceso ğŸ”</h2>
        <button class="main" onclick="modoInvitado()">Ingresar como Invitado ğŸ‘¤</button>
        <button class="main" onclick="modoAdmin()">Administrador ğŸ”‘</button>
    </div>

    <div id="panelSistema" style="display:none;">
        <div class="adminMode" id="modoTxt"></div>

        <div style="display:flex;gap:10px;margin-bottom:15px">
            <button onclick="tema()" class="main" style="flex:1;">ğŸŒ“ Tema</button>
            <button onclick="cerrarSesion()" class="main" style="flex:1;">Cerrar</button>
        </div>

        <div class="card">
            <h3>Agregar nueva peticiÃ³n</h3>
            <input id="nombre" placeholder="Nombre">
            <input id="ano" placeholder="AÃ±o">
            <select id="tipo">
                <option>Pelicula</option>
                <option>Serie</option>
            </select>
            <button class="main" onclick="add()">Enviar PeticiÃ³n</button>
        </div>

        <div class="card">
            <h3>Listado</h3>
            <select id="filtro" onchange="mostrar()">
                <option value="todos">Todos</option>
                <option value="pendientes">Pendientes</option>
                <option value="realizadas">Realizadas</option>
            </select>
            <input id="search" placeholder="Buscar..." oninput="mostrar()">
            <div id="lista" style="margin-top:12px;"></div>
        </div>
    </div>
</section>

<section id="reportPanel">
    <div id="loginReporte" class="card">
        <h2>Reportar Contenido CaÃ­do ğŸš¨</h2>
        <button class="main" onclick="modoInvitadoReporte()">Ingresar como Invitado ğŸ‘¤</button>
        <button class="main" onclick="modoAdminReporte()">Administrador ğŸ”‘</button>
    </div>

    <div id="panelReporteSistema" style="display:none;">
        <div class="adminMode" id="modoReporteTxt"></div>

        <div style="display:flex;gap:10px;margin-bottom:15px">
            <button onclick="tema()" class="main" style="flex:1;">ğŸŒ“ Tema</button>
            <button onclick="cerrarSesion()" class="main" style="flex:1;">Cerrar</button>
        </div>

        <div class="card">
            <h3>Reportar Contenido</h3>
            <input id="reporteTitulo" placeholder="TÃ­tulo del contenido caÃ­do">
            <select id="reporteTipo">
                <option>Pelicula</option>
                <option>Serie</option>
            </select>
            <button class="main" onclick="reportar()">Enviar Reporte</button>
        </div>

        <div class="card">
            <h3>Reportes</h3>
            <div id="listaReportes" style="margin-top:12px;"></div>
        </div>
    </div>
</section>

<div id="popup"><div>ğŸ“¨ Su solicitud ha sido enviada</div></div>

<div id="m3uPopup">
    <div id="m3uPopupContent">
        <h3>Archivo M3U Generado</h3>
        <textarea id="m3uContent" readonly></textarea>
        
        <div class="button-group">
            <button class="main" style="background:#444;" onclick="copiarM3u()">ğŸ“‹ Copiar Texto</button>
        </div>
        <div class="button-group">
            <button class="main" style="flex:1;" onclick="descargarM3u('m3u')">Descargar como .m3u</button>
            <button class="main" style="flex:1;background:#ff9900;" onclick="descargarM3u('txt')">Descargar como .txt</button>
        </div>
        <button class="main" style="margin-top:15px;background:#333;" onclick="document.getElementById('m3uPopup').style.display='none';">Cerrar</button>
    </div>
</div>

<script type="module">
// ----------------------------------------------------
// SUSTITUCIÃ“N DE FIREBASE POR SUPABASE - CREDENCIALES
// ----------------------------------------------------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// TUS CREDENCIALES DE SUPABASE INSERTADAS:
const supabaseUrl = 'https://lnxshgqeudirnkcmmrhf.supabase.co'; 
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueHNoZ3FldWRpcm5rY21tcmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDEwNDksImV4cCI6MjA4MDExNzA0OX0.7kLAynA-P0ILwhOBZVECcWNazpMh0Jt9rEud06brTuk'; 
const supabase = createClient(supabaseUrl, supabaseKey);

let petGlobal = [];
let reportGlobal = [];
let admin = false;

// DeclaraciÃ³n de variables de elementos HTML (EXISTENTES)
const nombre = document.getElementById("nombre");
const ano = document.getElementById("ano");
const tipo = document.getElementById("tipo");
const filtro = document.getElementById("filtro");
const search = document.getElementById("search");
const lista = document.getElementById("lista");
const reporteTitulo = document.getElementById("reporteTitulo");
const reporteTipo = document.getElementById("reporteTipo");
const listaReportes = document.getElementById("listaReportes");
const home = document.getElementById("home");
const peticionesPanel = document.getElementById("peticionesPanel");
const reportPanel = document.getElementById("reportPanel");
const loginBox = document.getElementById("loginBox");
const panelSistema = document.getElementById("panelSistema");
const modoTxt = document.getElementById("modoTxt");
const loginReporte = document.getElementById("loginReporte");
const panelReporteSistema = document.getElementById("panelReporteSistema");
const modoReporteTxt = document.getElementById("modoReporteTxt");
const popupElem = document.getElementById("popup");
const backButton = document.getElementById("backButton"); 

// DECLARACIÃ“N DE VARIABLES DE ELEMENTOS HTML (NUEVOS M3U)
const m3uPanel = document.getElementById("m3uPanel");
const m3uMoviesContainer = document.getElementById("m3uMoviesContainer");
const m3uPopup = document.getElementById("m3uPopup");
const m3uContent = document.getElementById("m3uContent");
const m3uPanelTitle = document.getElementById("m3uPanelTitle");
const m3uListTitle = document.getElementById("m3uListTitle");
const m3uInputOptions = document.getElementById("m3uInputOptions");
const m3uUrlInput = document.getElementById("m3uUrlInput");


// ----------------------------------------------------
// LÃ“GICA DE NAVEGACIÃ“N
// ----------------------------------------------------

window.volverAHome = () => {
    peticionesPanel.style.display="none";
    reportPanel.style.display="none";
    m3uPanel.style.display="none"; 
    home.style.display="block";
    backButton.style.display="none"; 
}


window.abrirPeticiones = () =>{
    home.style.display="none";
    reportPanel.style.display="none";
    m3uPanel.style.display="none"; 
    peticionesPanel.style.display="block";
    backButton.style.display="inline-block"; 
    
    loginBox.style.display = admin ? "none" : "block";
    panelSistema.style.display = admin ? "block" : "none";
    if(admin) iniciar();
}

window.abrirReportes = () =>{
    home.style.display="none";
    peticionesPanel.style.display="none";
    m3uPanel.style.display="none"; 
    reportPanel.style.display="block";
    backButton.style.display="inline-block"; 

    loginReporte.style.display = admin ? "none" : "block";
    panelReporteSistema.style.display = admin ? "block" : "none";
    
    iniciarReportes();
}

/**
 * FunciÃ³n unificada para abrir el panel M3U, en modo Crear o Editar.
 * @param {boolean} modoEditar - Si es true, activa el modo ediciÃ³n.
 */
window.abrirM3u = (modoEditar = false) =>{
    home.style.display="none";
    peticionesPanel.style.display="none";
    reportPanel.style.display="none";
    m3uPanel.style.display="block";
    backButton.style.display="inline-block"; 
    
    // Configurar la interfaz segÃºn el modo
    if (modoEditar) {
        m3uPanelTitle.textContent = "ğŸ“ Editor de Archivos M3U";
        m3uListTitle.textContent = "PelÃ­culas a Editar";
        m3uInputOptions.style.display = "block"; // Mostrar opciones de carga
        m3uUrlInput.value = ""; // Limpiar el campo de URL
    } else {
        m3uPanelTitle.textContent = "ğŸ“½ï¸ Generador de Archivos M3U";
        m3uListTitle.textContent = "Lista de PelÃ­culas";
        m3uInputOptions.style.display = "none"; // Ocultar opciones de carga
    }

    // Limpiar y asegurar que haya al menos una tarjeta vacÃ­a si no es modo ediciÃ³n
    if (m3uMoviesContainer.children.length === 0 || !modoEditar) {
        m3uMoviesContainer.innerHTML = '';
        agregarPelicula(); 
    }
}


// ----------------------------------------------------
// LÃ“GICA DE GENERADOR/EDITOR M3U
// ----------------------------------------------------

window.agregarPelicula = (nombre = '', enlace = '', portada = '') => {
    const card = document.createElement("div");
    card.className = "movieCard";
    card.setAttribute('data-id', Date.now()); 
    
    const cardCount = m3uMoviesContainer.children.length + 1;

    card.innerHTML = `
        <button class="remove-movie" onclick="quitarPelicula(this.parentElement)">âŒ</button>
        <h4>PelÃ­cula #${cardCount}</h4>
        <input class="m3u-nombre" placeholder="Nombre de la PelÃ­cula" required value="${nombre}">
        <input class="m3u-enlace" type="url" placeholder="Enlace (URL) del video/stream" required value="${enlace}">
        <input class="m3u-portada" type="url" placeholder="Portada (URL) de la imagen (opcional)" value="${portada}">
    `;
    
    m3uMoviesContainer.appendChild(card);
    actualizarNumeracionM3U();
}

window.quitarPelicula = (cardElement) => {
    cardElement.remove();
    // Si se queda vacÃ­o, aÃ±adir automÃ¡ticamente uno nuevo
    if (m3uMoviesContainer.children.length === 0) {
        agregarPelicula();
    }
    actualizarNumeracionM3U();
}

function actualizarNumeracionM3U() {
    Array.from(m3uMoviesContainer.children).forEach((card, index) => {
        const h4 = card.querySelector('h4');
        if (h4) {
            h4.textContent = `PelÃ­cula #${index + 1}`;
        }
    });
}

/**
 * NUEVO: Carga contenido M3U/TXT desde una URL.
 */
window.cargarUrlM3U = async () => {
    const url = m3uUrlInput.value.trim();
    if (!url) {
        alert("Por favor, introduce un enlace M3U o TXT vÃ¡lido.");
        return;
    }
    
    // Ocultar el contenido actual y mostrar un mensaje de carga
    m3uMoviesContainer.innerHTML = '<p style="text-align:center;">Cargando contenido desde la URL...</p>';

    try {
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error al cargar el enlace: ${response.statusText}`);
        }
        
        const content = await response.text();
        handleM3UContent(content, 'URL');
        
    } catch (error) {
        alert(`Error al cargar el M3U desde la URL. AsegÃºrate de que el enlace sea accesible y no tenga problemas de CORS. Detalle: ${error.message}`);
        console.error('Error de carga M3U/URL:', error);
        m3uMoviesContainer.innerHTML = '';
        agregarPelicula(); // Vuelve a una tarjeta vacÃ­a
    }
}


/**
 * Carga contenido M3U/TXT desde un archivo subido.
 */
window.cargarArchivoM3U = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        handleM3UContent(e.target.result, 'Archivo');
    };
    reader.onerror = function() {
        alert('Error al leer el archivo.');
        m3uMoviesContainer.innerHTML = '';
        agregarPelicula();
    };

    reader.readAsText(file);
    // Limpiar el input para permitir recargar el mismo archivo
    event.target.value = null; 
}


/**
 * NUEVO: Procesa el contenido M3U/TXT cargado (ya sea por URL o Archivo).
 */
function handleM3UContent(content, source) {
    // 1. Limpiar el contenedor actual
    m3uMoviesContainer.innerHTML = '';

    // 2. Parsear el contenido
    const movies = parseM3UContent(content);

    // 3. Cargar las pelÃ­culas en la interfaz
    if (movies.length > 0) {
        movies.forEach(movie => {
            agregarPelicula(movie.nombre, movie.enlace, movie.portada);
        });
        popupElem.children[0].textContent = `âœ… ${movies.length} pelÃ­culas cargadas desde ${source}.`;
    } else {
        // Si no se pudo parsear nada, se aÃ±ade una tarjeta vacÃ­a por defecto
        agregarPelicula(); 
        popupElem.children[0].textContent = `âš ï¸ No se encontraron pelÃ­culas vÃ¡lidas en el contenido de ${source}.`;
    }
    popup();
}


/**
 * Parsea el contenido de un archivo M3U/TXT.
 */
function parseM3UContent(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    const movies = [];
    let isM3UFormat = lines[0] === '#EXTM3U';

    if (isM3UFormat) {
        // Modo M3U (EXTINF)
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.startsWith('#EXTINF:')) {
                let name = line.substring(line.lastIndexOf(',') + 1).trim();
                let logoMatch = line.match(/tvg-logo="([^"]+)"/);
                let logo = logoMatch ? logoMatch[1] : '';

                // La URL debe estar en la siguiente lÃ­nea
                let url = lines[i + 1] && !lines[i + 1].startsWith('#') ? lines[i + 1] : '';

                if (name && url) {
                    movies.push({ nombre: name, enlace: url, portada: logo });
                }
            }
        }
    } else {
        // Modo TXT simple (asume que cada lÃ­nea es un enlace)
        lines.filter(line => line.startsWith('http')).forEach((url, index) => {
            movies.push({ 
                nombre: `Enlace Directo #${index + 1}`, 
                enlace: url, 
                portada: '' 
            });
        });
    }

    return movies;
}


window.generarM3u = () => {
    const movies = [];
    let valid = true;

    // Recorre todas las tarjetas de pelÃ­culas
    Array.from(m3uMoviesContainer.children).forEach(card => {
        const nombreInput = card.querySelector('.m3u-nombre');
        const enlaceInput = card.querySelector('.m3u-enlace');
        const portadaInput = card.querySelector('.m3u-portada');

        const nombre = nombreInput.value.trim();
        const enlace = enlaceInput.value.trim();
        const portada = portadaInput.value.trim();

        // Validar que el nombre y el enlace no estÃ©n vacÃ­os
        if (nombre && enlace) {
            movies.push({ nombre, enlace, portada });
        } else if (nombre || enlace) {
            // Si falta alguno de los dos campos principales
            valid = false;
        }
        // Si ambos estÃ¡n vacÃ­os, se ignora esa "tarjeta" si es la que queda por defecto
    });

    if (!valid) {
        alert("Por favor, rellena el Nombre y el Enlace de todas las pelÃ­culas que deseas incluir.");
        return;
    }
    
    if (movies.length === 0) {
        alert("Debes aÃ±adir al menos una pelÃ­cula vÃ¡lida para generar el archivo M3U.");
        return;
    }

    // CABECERA M3U EXTINF
    let m3uContentText = "#EXTM3U\n";

    movies.forEach(movie => {
        // Formato: #EXTINF:-1 tvg-logo="PORTADA",NOMBRE
        let line = `#EXTINF:-1`;
        if (movie.portada) {
            line += ` tvg-logo="${movie.portada}"`;
        }
        line += `,${movie.nombre}\n`;
        line += `${movie.enlace}\n`;
        
        m3uContentText += line;
    });

    // Mostrar el popup con el contenido generado
    m3uContent.value = m3uContentText;
    m3uPopup.style.display = "flex";
}


window.copiarM3u = () => {
    m3uContent.select();
    document.execCommand('copy');
    // Usar el popup genÃ©rico para notificar
    popupElem.children[0].textContent = "ğŸ“‹ Contenido M3U Copiado";
    popup();
}

window.descargarM3u = (ext) => {
    const text = m3uContent.value;
    if (!text) return;

    const filename = `playlist.${ext}`;
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
    
    // Usar el popup genÃ©rico para notificar
    popupElem.children[0].textContent = `ğŸ’¾ Archivo .${ext} Descargado`;
    popup();
}

// ----------------------------------------------------
// LÃ“GICA DE PETICIONES (EXISTENTE)
// ----------------------------------------------------

window.modoInvitado = ()=>{admin=false; iniciar();}
window.modoAdmin = ()=>{
    let u=prompt("Usuario:");let p=prompt("ContraseÃ±a:");
    if(u=="BflixTeam" && p=="PassBflixMovian"){admin=true;iniciar();}
    else alert("Acceso denegado âŒ");
}

function iniciar(){
    loginBox.style.display="none";
    panelSistema.style.display="block";
    modoTxt.textContent=admin?"Modo Administrador âœ”":"Modo Invitado ğŸ‘¤";
    cargarPeticiones();
}

window.add = async ()=>{
    let n=nombre.value.trim(),a=ano.value.trim(),t=tipo.value; 
    if(!n||!a) return alert("Completa todo");

    const { error } = await supabase
        .from('peticiones') 
        .insert({
            txt:`${n} (${a}) [${t}]`,
            real:false
        });
    
    if (error) {
        alert("Error al enviar la peticiÃ³n: " + error.message);
        console.error(error);
    } else {
        popupElem.children[0].textContent = "ğŸ“¨ Su solicitud ha sido enviada";
        popup();
        cargarPeticiones(); 
    }
}

async function cargarPeticiones(){
    const { data, error } = await supabase
        .from('peticiones')
        .select('id, txt, real') 
        .order('id', { ascending: false }); 

    if (error) {
        console.error("Error al cargar peticiones: ", error);
        petGlobal = []; 
    } else {
        petGlobal = data;
    }
    
    if(peticionesPanel.style.display === "block") mostrar();
}

window.mostrar = ()=>{
    lista.innerHTML="";
    
    const searchText = search.value ? search.value.toLowerCase() : "";

    petGlobal.forEach(x=>{
        if(filtro.value=="pendientes" && x.real) return;
        if(filtro.value=="realizadas" && !x.real) return;
        
        if (searchText && !x.txt.toLowerCase().includes(searchText)) return;

        let div=document.createElement("div");
        div.className="petItem";

        let estado = x.real
            ? "<b class='realizada'>âœ” REALIZADA âœ”</b>"
            : "<b style='color:#ff4d4d;'>ğŸš« PENDIENTE ğŸš«</b>";

        div.innerHTML=`<span>${x.txt} â€” ${estado}</span>`;
        
        let acciones = document.createElement("div"); // CREAMOS CONTENEDOR DE ACCIONES
        acciones.className = "acciones";

        if(admin){
            // BotÃ³n de eliminar, siempre visible para admin
            let bDelete=document.createElement("button");
            bDelete.textContent="âŒ Eliminar";
            bDelete.className = "eliminar";
            bDelete.onclick=()=>eliminarPeticion(x.id); 
            acciones.appendChild(bDelete);

            if(!x.real){
                let b=document.createElement("button");
                b.textContent="Marcar realizada âœ”";
                b.className = "marcar";
                b.onclick=()=>actualizarPeticion(x.id, { real: true }); 
                acciones.appendChild(b);
            }
        }
        
        if(acciones.children.length > 0) div.appendChild(acciones);

        lista.appendChild(div);
    });
}

async function actualizarPeticion(id, cambios) {
    const { error } = await supabase
        .from('peticiones')
        .update(cambios)
        .eq('id', id); 

    if (error) {
        alert("Error al actualizar la peticiÃ³n: " + error.message);
    } else {
        cargarPeticiones();
    }
}

window.eliminarPeticion = async (id) => {
    if (confirm("Â¿EstÃ¡s seguro de que quieres ELIMINAR esta peticiÃ³n?")) {
        const { error } = await supabase
            .from('peticiones')
            .delete()
            .eq('id', id);

        if (error) {
            alert("Error al eliminar la peticiÃ³n: " + error.message);
        } else {
            popupElem.children[0].textContent = "ğŸ—‘ï¸ PeticiÃ³n Eliminada";
            popup();
            cargarPeticiones();
        }
    }
}

// ----------------------------------------------------
// LÃ“GICA DE REPORTES (EXISTENTE)
// ----------------------------------------------------

window.modoInvitadoReporte = ()=>{admin=false; iniciarReportes();}
window.modoAdminReporte = ()=>{
    let u=prompt("Usuario:");let p=prompt("ContraseÃ±a:");
    if(u=="BflixTeam" && p=="PassBflixMovian"){admin=true;iniciarReportes();}
    else alert("Acceso denegado âŒ");
}

function iniciarReportes(){
    loginReporte.style.display="none";
    panelReporteSistema.style.display="block";

    modoReporteTxt.textContent=admin?"Modo Administrador âœ”":"Modo Invitado ğŸ‘¤";
    cargarReportes();
}

window.reportar = async ()=>{
    let t=reporteTitulo.value.trim(), tp=reporteTipo.value;
    if(!t) return alert("Completa el tÃ­tulo");

    const { error } = await supabase
        .from('reportes') 
        .insert({
            titulo:t,
            tipo:tp,
            reparado:false
        });

    if (error) {
        alert("Error al enviar el reporte: " + error.message);
        console.error(error);
    } else {
        popupElem.children[0].textContent = "ğŸ“¨ Su solicitud ha sido enviada";
        popup();
        cargarReportes(); 
    }
}

async function cargarReportes(){
    const { data, error } = await supabase
        .from('reportes')
        .select('id, titulo, tipo, reparado')
        .order('id', { ascending: false });

    if (error) {
        console.error("Error al cargar reportes: ", error);
        reportGlobal = []; 
    } else {
        reportGlobal = data;
    }
    
    if(reportPanel.style.display === "block") mostrarReportes();
}

window.mostrarReportes = ()=>{
    listaReportes.innerHTML="";
    
    reportGlobal.forEach(x=>{
        if(!admin && x.reparado) return;

        let div=document.createElement("div");
        div.className="petItem";

        let estado = x.reparado
            ? "<b class='realizada'>âœ” REPARADO âœ”</b>"
            : "<b style='color:#ff4d4d;'>ğŸš« CAÃDO ğŸš«</b>";
        
        div.innerHTML=`<span>${x.titulo} [${x.tipo}] â€” ${estado}</span>`;

        if(admin){
            let acciones = document.createElement("div");
            acciones.className = "acciones";
            
            // BotÃ³n de eliminar, siempre visible para admin
            let bDelete=document.createElement("button");
            bDelete.textContent="âŒ Eliminar";
            bDelete.className = "eliminar";
            bDelete.onclick=()=>eliminarReporte(x.id); 
            acciones.appendChild(bDelete);
            
            if(!x.reparado){
                let b=document.createElement("button");
                b.textContent="Marcar Reparado âœ”";
                b.className = "marcar";
                b.onclick=()=>actualizarReporte(x.id, { reparado: true }); 
                acciones.appendChild(b);
            }
            
            div.appendChild(acciones);
        }

        listaReportes.appendChild(div);
    });

    if(listaReportes.children.length === 0){
        listaReportes.innerHTML = `<p style="opacity:.6;text-align:center;">${admin ? "No hay reportes pendientes." : "No hay contenido caÃ­do reportado."}</p>`;
    }
}

async function actualizarReporte(id, cambios) {
    const { error } = await supabase
        .from('reportes')
        .update(cambios)
        .eq('id', id);

    if (error) {
        alert("Error al actualizar el reporte: " + error.message);
    } else {
        cargarReportes();
    }
}

window.eliminarReporte = async (id) => {
    if (confirm("Â¿EstÃ¡s seguro de que quieres ELIMINAR este reporte de contenido caÃ­do?")) {
        const { error } = await supabase
            .from('reportes')
            .delete()
            .eq('id', id);

        if (error) {
            alert("Error al eliminar el reporte: " + error.message);
        } else {
            popupElem.children[0].textContent = "ğŸ—‘ï¸ Reporte Eliminado";
            popup();
            cargarReportes();
        }
    }
}


// ----------------------------------------------------
// LÃ“GICA COMPARTIDA
// ----------------------------------------------------

window.cerrarSesion = ()=>location.reload();

function popup(){
    popupElem.style.display="flex"; 
    setTimeout(()=>popupElem.style.display="none",1700);
    // Reiniciar el texto del popup al genÃ©rico despuÃ©s de usarlo con otra funciÃ³n
    setTimeout(()=>popupElem.children[0].textContent = "ğŸ“¨ Su solicitud ha sido enviada", 1800);
}

window.tema = ()=>document.body.classList.toggle("light");

// Cargamos las listas al inicio
cargarPeticiones();
cargarReportes();
</script>

</body>
                </html>

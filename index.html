<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bflix</title>

<style>
    :root{
        --bg:#0a0a0a;
        --card:#111;
        --txt:#fff;
        --btn:#18ff8f;
    }
    body.light{
        --bg:#f6f6f6;
        --card:#ffffff;
        --txt:#111;
        --btn:#00c06f;
    }

    body{
        background:var(--bg);
        margin:0;
        font-family:Arial, sans-serif;
        color:var(--txt);
        transition:.3s;
    }

    nav{
        background:#000;
        padding:15px 22px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:22px;
    }
    nav span{
        font-weight:bold;
        color:#18ff8f;
    }
    nav button{
        background:none;border:none;
        font-size:20px;color:white;
        cursor:pointer;
    }
    nav button:first-of-type {
        margin-right: 15px;
    }

    #home{
        text-align:center;margin-top:100px;
    }
    #home h1{font-size:38px;margin-bottom:6px;}
    #home p{opacity:.8;margin-bottom:25px;}
    #home button{
        padding:10px 24px;border-radius:6px;
        border:none;background:var(--btn);
        font-size:18px;font-weight:bold;
        cursor:pointer;
    }

    #peticionesPanel, #reportPanel{
        display:none;padding:25px;
        max-width:800px;margin:auto;
    }

    .adminMode{color:#18ff8f;font-weight:bold;margin-bottom:10px;}

    .card{
        background:var(--card);
        padding:18px;
        border-radius:12px;
        margin-bottom:22px;
    }

    input,select{
        width:100%;padding:10px;margin-top:8px;
        background:#0003;border:none;
        border-radius:8px;color:var(--txt);
        font-size:16px;
    }

    button.main{
        background:var(--btn);border:none;
        padding:11px 20px;font-weight:bold;
        border-radius:8px;width:100%;margin-top:10px;
        cursor:pointer;color:black;
    }

    .petItem{
        background:var(--card);
        padding:12px;border-radius:8px;
        display:flex;justify-content:space-between;
        margin-bottom:10px;
    }
    .acciones button{
        background:none;border:none;color:var(--btn);
        margin-left:6px;cursor:pointer;
    }
    .realizada{color:#00ff6a;font-weight:bold;}

    #popup{
        display:none;position:fixed;inset:0;
        background:#000000aa;backdrop-filter:blur(3px);
        justify-content:center;align-items:center;
    }
    #popup div{
        background:white;color:black;
        padding:25px;border-radius:12px;
        font-size:20px;text-align:center;
        animation:show .3s;
    }
    @keyframes show{from{scale:.6;opacity:0;}to{scale:1;opacity:1;}}
</style>
</head>
<body>

<nav>
    <span>Bflix</span>
    <button onclick="abrirPeticiones()">ğŸ“© Peticiones</button>
    <button onclick="abrirReportes()">ğŸš¨ Reportar CaÃ­do</button>
</nav>

<section id="home">
    <h1>Bienvenido a Bflix</h1>
    <p>Centro multimedia, herramientas y peticiones.</p>
    <button onclick="abrirPeticiones()">Ir a Peticiones ğŸ“©</button>
    <button onclick="abrirReportes()">Reportar CaÃ­do ğŸš¨</button>
</section>

<section id="peticionesPanel">
    <div id="loginBox" class="card">
        <h2>Acceso ğŸ”</h2>
        <button class="main" onclick="modoInvitado()">Ingresar como Invitado ğŸ‘¤</button>
        <button class="main" onclick="modoAdmin()">Administrador ğŸ”‘</button>
    </div>

    <div id="panelSistema" style="display:none;">
        <div class="adminMode" id="modoTxt"></div>

        <div style="display:flex;gap:10px;margin-bottom:15px">
            <button onclick="tema()" class="main" style="flex:1;">ğŸŒ“ Tema</button>
            <button onclick="cerrarSesion()" class="main" style="flex:1;">Cerrar</button>
        </div>

        <div class="card">
            <h3>Agregar nueva peticiÃ³n</h3>
            <input id="nombre" placeholder="Nombre">
            <input id="ano" placeholder="AÃ±o">
            <select id="tipo">
                <option>Pelicula</option>
                <option>Serie</option>
            </select>
            <button class="main" onclick="add()">Enviar PeticiÃ³n</button>
        </div>

        <div class="card">
            <h3>Listado</h3>
            <select id="filtro" onchange="mostrar()">
                <option value="todos">Todos</option>
                <option value="pendientes">Pendientes</option>
                <option value="realizadas">Realizadas</option>
            </select>
            <input id="search" placeholder="Buscar..." oninput="mostrar()">
            <div id="lista" style="margin-top:12px;"></div>
        </div>
    </div>
</section>

<section id="reportPanel">
    <div id="loginReporte" class="card">
        <h2>Reportar Contenido CaÃ­do ğŸš¨</h2>
        <button class="main" onclick="modoInvitadoReporte()">Ingresar como Invitado ğŸ‘¤</button>
        <button class="main" onclick="modoAdminReporte()">Administrador ğŸ”‘</button>
    </div>

    <div id="panelReporteSistema" style="display:none;">
        <div class="adminMode" id="modoReporteTxt"></div>

        <div style="display:flex;gap:10px;margin-bottom:15px">
            <button onclick="tema()" class="main" style="flex:1;">ğŸŒ“ Tema</button>
            <button onclick="cerrarSesion()" class="main" style="flex:1;">Cerrar</button>
        </div>

        <div class="card">
            <h3>Reportar Contenido</h3>
            <input id="reporteTitulo" placeholder="TÃ­tulo del contenido caÃ­do">
            <select id="reporteTipo">
                <option>Pelicula</option>
                <option>Serie</option>
            </select>
            <button class="main" onclick="reportar()">Enviar Reporte</button>
        </div>

        <div class="card">
            <h3>Reportes</h3>
            <div id="listaReportes" style="margin-top:12px;"></div>
        </div>
    </div>
</section>

<div id="popup"><div>ğŸ“¨ Su solicitud ha sido enviada</div></div>

<script type="module">
// ----------------------------------------------------
// SUSTITUCIÃ“N DE FIREBASE POR SUPABASE - CREDENCIALES
// ----------------------------------------------------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// TUS CREDENCIALES DE SUPABASE INSERTADAS:
const supabaseUrl = 'https://lnxshgqeudirnkcmmrhf.supabase.co'; 
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueHNoZ3FldWRpcm5rY21tcmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDEwNDksImV4cCI6MjA4MDExNzA0OX0.7kLAynA-P0ILwhOBZVECcWNazpMh0Jt9rEud06brTuk'; 
const supabase = createClient(supabaseUrl, supabaseKey);

let petGlobal = [];
let reportGlobal = [];
let admin = false;

// DeclaraciÃ³n de variables de elementos HTML
const nombre = document.getElementById("nombre");
const ano = document.getElementById("ano");
const tipo = document.getElementById("tipo");
const filtro = document.getElementById("filtro");
const search = document.getElementById("search");
const lista = document.getElementById("lista");

const reporteTitulo = document.getElementById("reporteTitulo");
const reporteTipo = document.getElementById("reporteTipo");
const listaReportes = document.getElementById("listaReportes");

const home = document.getElementById("home");
const peticionesPanel = document.getElementById("peticionesPanel");
const reportPanel = document.getElementById("reportPanel");
const loginBox = document.getElementById("loginBox");
const panelSistema = document.getElementById("panelSistema");
const modoTxt = document.getElementById("modoTxt");
const loginReporte = document.getElementById("loginReporte");
const panelReporteSistema = document.getElementById("panelReporteSistema");
const modoReporteTxt = document.getElementById("modoReporteTxt");
const popupElem = document.getElementById("popup");


// ----------------------------------------------------
// LÃ“GICA DE NAVEGACIÃ“N
// ----------------------------------------------------

window.abrirPeticiones = () =>{
    home.style.display="none";
    reportPanel.style.display="none";
    peticionesPanel.style.display="block";
    
    loginBox.style.display = admin ? "none" : "block";
    panelSistema.style.display = admin ? "block" : "none";
    if(admin) iniciar();
}

window.abrirReportes = () =>{
    home.style.display="none";
    peticionesPanel.style.display="none";
    reportPanel.style.display="block";

    loginReporte.style.display = admin ? "none" : "block";
    panelReporteSistema.style.display = admin ? "block" : "none";
    
    iniciarReportes();
}

// ----------------------------------------------------
// LÃ“GICA DE PETICIONES
// ----------------------------------------------------

window.modoInvitado = ()=>{admin=false; iniciar();}
window.modoAdmin = ()=>{
    let u=prompt("Usuario:");let p=prompt("ContraseÃ±a:");
    if(u=="BflixTeam" && p=="PassBflixMovian"){admin=true;iniciar();}
    else alert("Acceso denegado âŒ");
}

function iniciar(){
    loginBox.style.display="none";
    panelSistema.style.display="block";
    modoTxt.textContent=admin?"Modo Administrador âœ”":"Modo Invitado ğŸ‘¤";
    cargarPeticiones();
}

window.add = async ()=>{
    let n=nombre.value.trim(),a=ano.value.trim(),t=tipo.value; 
    if(!n||!a) return alert("Completa todo");

    const { error } = await supabase
        .from('peticiones') 
        .insert({
            txt:`${n} (${a}) [${t}]`,
            real:false
        });
    
    if (error) {
        alert("Error al enviar la peticiÃ³n: " + error.message);
        console.error(error);
    } else {
        popup();
        cargarPeticiones(); 
    }
}

async function cargarPeticiones(){
    const { data, error } = await supabase
        .from('peticiones')
        .select('id, txt, real') 
        .order('id', { ascending: false }); 

    if (error) {
        console.error("Error al cargar peticiones: ", error);
        petGlobal = []; 
    } else {
        petGlobal = data;
    }
    
    if(peticionesPanel.style.display === "block") mostrar();
}

window.mostrar = ()=>{
    lista.innerHTML="";
    
    const searchText = search.value ? search.value.toLowerCase() : "";

    petGlobal.forEach(x=>{
        if(filtro.value=="pendientes" && x.real) return;
        if(filtro.value=="realizadas" && !x.real) return;
        
        if (searchText && !x.txt.toLowerCase().includes(searchText)) return;

        let div=document.createElement("div");
        div.className="petItem";

        let estado = x.real
            ? "<b class='realizada'>âœ” REALIZADA âœ”</b>"
            : "<b style='color:#ff4d4d;'>ğŸš« PENDIENTE ğŸš«</b>";

        div.innerHTML=`<span>${x.txt} â€” ${estado}</span>`;

        if(admin && !x.real){
            let b=document.createElement("button");
            b.textContent="Marcar realizada âœ”";
            b.onclick=()=>actualizarPeticion(x.id, { real: true }); 
            div.appendChild(b);
        }

        lista.appendChild(div);
    });
}

async function actualizarPeticion(id, cambios) {
    const { error } = await supabase
        .from('peticiones')
        .update(cambios)
        .eq('id', id); 

    if (error) {
        alert("Error al actualizar la peticiÃ³n: " + error.message);
    } else {
        cargarPeticiones();
    }
}

// ----------------------------------------------------
// LÃ“GICA DE REPORTES
// ----------------------------------------------------

window.modoInvitadoReporte = ()=>{admin=false; iniciarReportes();}
window.modoAdminReporte = ()=>{
    let u=prompt("Usuario:");let p=prompt("ContraseÃ±a:");
    if(u=="BflixTeam" && p=="PassBflixMovian"){admin=true;iniciarReportes();}
    else alert("Acceso denegado âŒ");
}

function iniciarReportes(){
    loginReporte.style.display="none";
    panelReporteSistema.style.display="block";

    modoReporteTxt.textContent=admin?"Modo Administrador âœ”":"Modo Invitado ğŸ‘¤";
    cargarReportes();
}

window.reportar = async ()=>{
    let t=reporteTitulo.value.trim(), tp=reporteTipo.value;
    if(!t) return alert("Completa el tÃ­tulo");

    const { error } = await supabase
        .from('reportes') 
        .insert({
            titulo:t,
            tipo:tp,
            reparado:false
        });

    if (error) {
        alert("Error al enviar el reporte: " + error.message);
        console.error(error);
    } else {
        popup();
        cargarReportes(); 
    }
}

async function cargarReportes(){
    const { data, error } = await supabase
        .from('reportes')
        .select('id, titulo, tipo, reparado')
        .order('id', { ascending: false });

    if (error) {
        console.error("Error al cargar reportes: ", error);
        reportGlobal = []; 
    } else {
        reportGlobal = data;
    }
    
    if(reportPanel.style.display === "block") mostrarReportes();
}

window.mostrarReportes = ()=>{
    listaReportes.innerHTML="";
    
    reportGlobal.forEach(x=>{
        if(!admin && x.reparado) return;

        let div=document.createElement("div");
        div.className="petItem";

        let estado = x.reparado
            ? "<b class='realizada'>âœ” REPARADO âœ”</b>"
            : "<b style='color:#ff4d4d;'>ğŸš« CAÃDO ğŸš«</b>";
        
        div.innerHTML=`<span>${x.titulo} [${x.tipo}] â€” ${estado}</span>`;

        if(admin && !x.reparado){
            let acciones = document.createElement("div");
            acciones.className = "acciones";
            let b=document.createElement("button");
            b.textContent="Marcar Reparado âœ”";
            b.onclick=()=>actualizarReporte(x.id, { reparado: true }); 
            acciones.appendChild(b);
            div.appendChild(acciones);
        }

        listaReportes.appendChild(div);
    });

    if(listaReportes.children.length === 0){
        listaReportes.innerHTML = `<p style="opacity:.6;text-align:center;">${admin ? "No hay reportes pendientes." : "No hay contenido caÃ­do reportado."}</p>`;
    }
}

async function actualizarReporte(id, cambios) {
    const { error } = await supabase
        .from('reportes')
        .update(cambios)
        .eq('id', id);

    if (error) {
        alert("Error al actualizar el reporte: " + error.message);
    } else {
        cargarReportes();
    }
}


// ----------------------------------------------------
// LÃ“GICA COMPARTIDA
// ----------------------------------------------------

window.cerrarSesion = ()=>location.reload();

function popup(){
    popupElem.style.display="flex"; 
    setTimeout(()=>popupElem.style.display="none",1700);
}

window.tema = ()=>document.body.classList.toggle("light");

// Cargamos las listas al inicio
cargarPeticiones();
cargarReportes();

</script>

</body>
</html>
